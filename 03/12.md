### âœï¸ Tangxt â³ 2022-05-12 ðŸ·ï¸ å°ç¨‹åº

# 12-å°ç¨‹åºç™»å½•è§£æžå’Œåˆ†åŒ…å¤„ç†

1ï¼‰

ðŸ’¡ï¼šå…¬å¸é¡¹ç›®ç”¨ rematchã€reselect ç­‰è¿™æ ·æˆ‘æ²¡æœ‰æŽ¥è§¦è¿‡çš„åº“

çœ‹æ–‡æ¡£æ˜¯å¦å¥å…¨ï¼Œä¸€ä¸ªåº“çš„æ–‡æ¡£å¥å…¨ï¼Œé‚£å­¦èµ·æ¥æ˜¯éžå¸¸å¿«çš„ï¼Œä¸ç®¡æ˜¯å•¥æ¡†æž¶

ðŸ’¡ï¼šå¦‚ä½•ç»™å¼€æºé¡¹ç›®æ·»åŠ è‡ªå·±çš„ä»£ç ï¼Ÿ

1. è‡ªå·±ä¸‹è½½è¿™ä¸ªä»£ç ï¼Œè§‰å¾—æŸä¸ªåŠŸèƒ½æ²¡æœ‰æˆ–è€…ä¸å¥½ç”¨ï¼Œè‡ªå·±æ·»åŠ åŠŸèƒ½ï¼Œè‡ªå·±ä½¿ç”¨æˆ–è€…ç»™è¯¥é¡¹ç›®ä¸€ä¸ª PRï¼Œä¹Ÿè®¸ä½œè€…ä¼šåˆå¹¶
2. é¡¹ç›®æœ‰ bugï¼Œè‡ªå·±å¤„ç†ï¼Œæ PR

ç»™çŸ¥åé¡¹ç›®æ PRï¼Œå¯ä»¥å†™åˆ°ç®€åŽ†é‡Œè¾¹åŽ»

çœ‹æºç ä¿®æ”¹æºç ï¼Œå¾ˆå°‘ä¼šè¿™æ ·ï¼Œå¾ˆå¤šéƒ½æ˜¯åŠŸèƒ½ä¸è¶³æˆ–æœ‰ bugï¼

å½“ç„¶ï¼Œå¯¹äºŽè‹±æ–‡æ–‡æ¡£ï¼Œåˆå¹¶è´¼å¿«ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªé¡¹ç›®æœ‰ä¸“é—¨çš„äººæ¥ç®¡ç†ï¼

2ï¼‰æŽŒæ¡æ’­æ”¾å·¥å…·æ å ä½ã€ç‚¹å‡»è·³è½¬å¤„ç†

ðŸ’¡ï¼šç›®å‰ä»£ç å­˜åœ¨çš„å°é—®é¢˜

![å°é—®é¢˜](assets/img/2022-05-13-19-41-18.png)

ä¸ºä»€ä¹ˆç»™`currentSong`çš„åˆå§‹å€¼æ˜¯`{}`ï¼Œè€Œä¸æ˜¯`null`æˆ–`undefined`è¿™æ ·çš„å€¼ï¼Ÿ -> å› ä¸ºè¦é¿å…`null.id`æˆ–`undefined.id`è¿™æ ·çš„æŠ¥é”™æƒ…å†µ

æ‰€ä»¥å¯¹äºŽè¿™ä¸ª`currentSong`æœ€åŽä¼šæœ‰æ‹¿`xxx.id`è¿™æ ·çš„å±žæ€§å€¼ï¼Œå»ºè®®åˆå§‹å€¼ä¸ºç©ºå¯¹è±¡`{}`ï¼Œå½“ç„¶ï¼Œä½ å†™`null`ä¹Ÿè¡Œï¼Œä¸è¿‡ï¼Œé™¤äº†åœ¨é¦–é¡µè¦å†™ä»¥å¤–ï¼Œä¾›äº«çš„`currentSong`çš„åˆå§‹å€¼ä¹Ÿè¦æ”¹ä¸º`null`ï¼Œæ¯•ç«Ÿ`event-store`ä¼šåˆå§‹åŒ–ä¸€æ¬¡

![bug è§£å†³](assets/img/2022-05-13-19-47-02.png)

ðŸ’¡ï¼šå¦‚æžœä½ å‘çŽ°æ’­æ”¾æ¡è·Ÿç€é¡µé¢æ»š

è¿™æ˜¯æ¨¡æ‹Ÿå™¨çš„é—®é¢˜ï¼ŒçœŸæœºä¸Šä¸ä¼šå‡ºçŽ°è¿™ä¸ªé—®é¢˜

ðŸ’¡ï¼šæ’­æ”¾æ¡é®ä½å¤„ç†

![æ’­æ”¾æ¡](assets/img/2022-05-13-19-52-36.png)

ðŸ’¡ï¼šç‚¹å‡»æ’­æ”¾æ¡ï¼Œä¼šè·³åˆ°æ’­æ”¾è¯¦æƒ…ï¼Œç”±äºŽæ•°æ®æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥æ’­æ”¾åˆ°å“ªï¼Œè¿›åº¦æ¡ä¼šå±•ç¤ºåˆ°å“ªå„¿

![bug](assets/img/2022-05-13-19-55-46.png)

ä¸ºå•¥ä¼šè¿™æ ·ï¼Ÿ -> äº‹ä»¶å‘ä¸Šä¼ é€’äº†

ç”¨`catchtap`ç›‘å¬æ’­æ”¾æˆ–æš‚åœæŒ‰é’®

![å†’æ³¡](assets/img/2022-05-13-19-58-50.png)

> [Demo](https://github.com/ppambler/QQMusic/commit/c4410ed)

![æ•ˆæžœ](assets/img/2022-05-13-20-10-01.png)

3ï¼‰æŽŒæ¡ä½¿ç”¨èƒŒæ™¯æ’­æ”¾å™¨æ¥æ’­æ”¾éŸ³ä¹

> 2 22 51

ðŸ’¡ï¼šèƒ½åœ¨å‰å°ï¼ˆä½ çœ‹åˆ°çš„å°ç¨‹åºç•Œé¢ï¼‰æ’­æ”¾ï¼Œä¹Ÿèƒ½åœ¨åŽå°ï¼ˆä½ çœ‹åˆ°çš„å¾®ä¿¡ç•Œé¢æˆ–æ¡Œé¢ï¼‰æ’­æ”¾

æ–‡æ¡£ï¼š[wx.playBackgroundAudio(Object object) - å¾®ä¿¡å¼€æ”¾æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/media/background-audio/wx.playBackgroundAudio.html)

- å‰å°ç”¨ï¼š`createInnerAudioContext`
- åŽå°ç”¨ï¼š`getBackgroundAudioManager` -> ä¹Ÿè¦è®°å½•å¾ˆå¤šä¿¡æ¯ï¼Œæ¯”å¦‚ä¸€äº› APP ä¼šåœ¨æ‰‹æœºæ¡Œé¢æ‹‰ä¸‹æ¥çš„æ—¶å€™å±•ç¤ºè¿›åº¦ç­‰

åŽå°æ’­æ”¾é¡µå†™ä¸€ä»½å—ï¼Ÿ -> ä¸éœ€è¦ï¼Œæˆ‘ä»¬å‰åŽå°ï¼Œéƒ½ç”¨åŽå°æ’­æ”¾çš„ API -> ä¸ºå•¥ä¸€å¼€å§‹ä¸ç”¨ åŽå°æ’­æ”¾çš„ APIï¼Ÿå› ä¸ºä¸€èˆ¬éƒ½æ˜¯ç”¨å‰å°æ’­æ”¾çš„ API

å½“ç„¶ï¼Œå®ƒä»¬ä¿©çš„æ’­æ”¾ API å‡ ä¹Žä¸€æ ·

æŠŠ`wx.createInnerAudioContext`æ”¹æˆæ˜¯`wx.getBackgroundAudioManager`å°±å¥½äº†

è¿˜éœ€è¦æ·»åŠ ä¸€ä¸ªé…ç½®ï¼š

![é…ç½®](assets/img/2022-05-13-21-00-23.png)

å¦‚æžœå®¡æ ¸é©³å›žäº†ï¼Œé‚£ä½ å°±è¦åšå…¶å®ƒä¿®æ”¹äº†

å½“ç„¶ï¼Œæ·»åŠ äº†é…ç½®è¿˜ä¸å¤Ÿ -> å¯ä»¥æŽ§åˆ¶é‚£ä¸ªæ’­æ”¾å°çª—å£çš„ä½ç½®

éœ€è¦è®¾ç½®`title`

![title](assets/img/2022-05-13-21-03-33.png)

> [Demo](https://github.com/ppambler/QQMusic/commit/dfa4b1d)

![èƒŒæ™¯æ’­æ”¾](assets/img/2022-05-13-21-11-14.png)

4ï¼‰æŽŒæ¡èƒŒæ™¯æ’­æ”¾çš„æš‚åœ-æ’­æ”¾-åœæ­¢å¤„ç†

> 2 7 34

ðŸ’¡ï¼šç›®å‰çš„é—®é¢˜

![æ’­æ”¾å’Œæš‚åœ](assets/img/2022-05-14-09-50-22.png)

ç›®å‰çš„é—®é¢˜ï¼š

![é—®é¢˜](assets/img/2022-05-14-09-51-53.png)

çŠ¶æ€æ”¹å˜ï¼š

![çŠ¶æ€](assets/img/2022-05-14-09-54-54.png)

ä¸è¿‡è¿™æœ‰ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯åœ¨æ‹–åŠ¨è¿›åº¦æ¡çš„æ—¶å€™ï¼Œæ’­æ”¾æŒ‰é’®ä¼šåˆ‡æ¢æˆæš‚åœï¼Œç„¶åŽå†æ’­æ”¾â€¦â€¦

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³ï¼š

æ–¹æ³•ä¸€ï¼š

![ä¸€](assets/img/2022-05-14-09-58-30.png)

å¯¹äºŽ`audioContext`è€Œæ²¡æœ‰æš‚åœï¼Œç­‰ç¼“å­˜ä¸‹æ¥äº†ï¼Œå°±å¼€å§‹æ’­æ”¾

æ–¹æ³•äºŒï¼š

é€šè¿‡è¿›åº¦æ”¹çš„ï¼Œå°±ä¸éœ€è¦æ”¹çŠ¶æ€äº†

![onCanplay](assets/img/2022-05-14-11-20-35.png)

ä¸è¿‡ï¼Œ`onCanplay` bugï¼Œä¹Ÿå°±æ˜¯å¤ªç»å¸¸å‡ºçŽ°ä¸å›žè°ƒ

âž¹ï¼š[æ­£å¸¸ç½‘ç»œéŸ³é¢‘ç”¨ BackgroundAudio æ’­æ”¾ï¼Œå¾ˆä¹…æ‰å›žè°ƒ onCanPlay - å¾®ä¿¡å¼€æ”¾ç¤¾åŒº](https://developers.weixin.qq.com/community/minigame/doc/000e2061bb8f8032c3a7bc1375b400)

æ‰€ä»¥ï¼Œæ–¹æ³•äºŒï¼Œä¸è¦ç”¨ï¼Œç”¨æ–¹æ³•ä¸€å°±å¥½äº†

IOS å’Œ Android çš„ä¸åŒï¼š

![IOS](assets/img/2022-05-14-14-09-20.png)

![ä¸Šä¸€é¦–](assets/img/2022-05-14-14-10-13.png)

ðŸ’¡ï¼š`BackgroundAudioManager.onStop`

è¿™ä¸ª API è°ƒç”¨äº†ï¼š

![API](assets/img/2022-05-14-14-20-07.png)

ä¼šæ¸…ç©º`audioContext`è¿™é‡Œè¾¹ä¿å­˜çš„è¿™äº›æ•°æ® -> é‡æ–°è®¾ç½®è¿™äº›æ•°æ® -> è¿™ä¼šé‡å¤´æ’­æ”¾ï¼ˆQQ éŸ³ä¹å’Œç½‘æ˜“äº‘éŸ³ä¹éƒ½æ˜¯è¿™æ ·ï¼‰

5ï¼‰

> 1 37










